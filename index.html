<script>
  const PASSWORD = "amns123";
  let faceMatcher;
  let storedDescriptor = null;

  async function startFaceCheck() {
    const status = document.getElementById("status");
    const userPwd = document.getElementById("password").value;
    if (userPwd !== PASSWORD) {
      status.textContent = "‚ùå Incorrect password.";
      status.style.color = "red";
      return;
    }

    status.textContent = "‚úÖ Password matched. Starting camera...";
    status.style.color = "green";

    await loadModels();
    await setupCamera();
    status.textContent = "üì∑ Capturing reference face...";
    await new Promise(resolve => setTimeout(resolve, 3000)); // Wait 3 seconds

    const video = document.getElementById("video");
    const reference = await faceapi.detectSingleFace(video, new faceapi.TinyFaceDetectorOptions()).withFaceLandmarks().withFaceDescriptor();

    if (!reference) {
      status.textContent = "‚ùå Could not capture face. Try again.";
      status.style.color = "red";
      return;
    }

    storedDescriptor = reference.descriptor;
    faceMatcher = new faceapi.FaceMatcher(storedDescriptor);

    status.textContent = "‚úÖ Face captured. Matching again...";
    await detectFace();
  }

  async function loadModels() {
    await faceapi.nets.tinyFaceDetector.loadFromUri("https://cdn.jsdelivr.net/npm/face-api.js/models");
    await faceapi.nets.faceRecognitionNet.loadFromUri("https://cdn.jsdelivr.net/npm/face-api.js/models");
    await faceapi.nets.faceLandmark68Net.loadFromUri("https://cdn.jsdelivr.net/npm/face-api.js/models");
  }

  async function setupCamera() {
    const video = document.getElementById("video");
    try {
      const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "user" } });
      video.srcObject = stream;
      return new Promise(resolve => video.onloadedmetadata = resolve);
    } catch (err) {
      document.getElementById("status").textContent = "‚ùå Cannot access camera: " + err.message;
      document.getElementById("status").style.color = "red";
    }
  }

  async function detectFace() {
    const status = document.getElementById("status");
    const video = document.getElementById("video");

    status.textContent = "üîç Matching face...";
    await new Promise(resolve => setTimeout(resolve, 3000)); // wait 3 sec for face detection

    const result = await faceapi.detectSingleFace(video, new faceapi.TinyFaceDetectorOptions()).withFaceLandmarks().withFaceDescriptor();

    if (!result) {
      status.textContent = "‚ùå Face not detected. Try again.";
      status.style.color = "red";
      return;
    }

    const match = faceMatcher.findBestMatch(result.descriptor);
    if (match.distance < 0.6) {
      status.textContent = "üîì Door Unlocked!";
      status.style.color = "green";
      // Optional: fetch("http://192.168.x.x/unlock");
    } else {
      status.textContent = "‚ùå Face not matched.";
      status.style.color = "red";
    }
  }
</script>
